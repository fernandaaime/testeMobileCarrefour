image: node:18  # Usa uma imagem do Node.js compatível

variables:
  ANDROID_HOME: "/opt/android-sdk"
  APPIUM_VERSION: "1.22.0"

stages:
  - setup
  - test

setup-environment:
  stage: setup
  script:
    - echo "Verificando instalando o Appium..."
    - if ! command -v appium &> /dev/null; then echo "Appium não encontrado! Instalando..."; npm install -g appium; fi
    - appium --version
    - echo "Instalando dependências..."
    - npm install -g codeceptjs  # Instala CodeceptJS globalmente
    - npm install  # Instala todas as dependências do projeto
    - apt-get update && apt-get install -y curl unzip openjdk-17-jdk
    - JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))  # Define JAVA_HOME dinamicamente
    - export JAVA_HOME
    - export PATH="$JAVA_HOME/bin:$PATH"
    - echo "Verificando instalação do Java..."
    - java -version  # Confirma que o Java está instalado corretamente
    - echo JAVA_HOME="$JAVA_HOME"

run-tests:
  script:
    - echo "Verificando se Appium está rodando..."
    - ps aux | grep appium  # Verifica se o processo do Appium está ativo
    - echo "Iniciando Appium Server..."
    - nohup appium --address 0.0.0.0 --port 4723 > /builds/${CI_PROJECT_PATH}/appium.log 2>&1 &
    - sleep 30  # Aguarda tempo suficiente para inicialização
    - echo "Verificando se o arquivo de log do Appium foi criado..."
    - ls -lh /builds/${CI_PROJECT_PATH}/appium.log  # Confirma que o log existe
    - tail -20 /builds/${CI_PROJECT_PATH}/appium.log  # Exibe os últimos logs para verificar possíveis erros
    - echo "Verificando conexão com Appium..."
    - curl --retry 15 --retry-delay 3 --retry-connrefused http://localhost:4723/wd/hub/status
    - echo "Executando testes no diretório correto..."
    - cd /builds/${CI_PROJECT_PATH}
    - npm install
    - npx codeceptjs run
  artifacts:
    paths:
      - reports/
    when: always
